rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ——— SEGÉDFÜGGVÉNYEK ——— */
    function signedIn()      { return request.auth != null; }
    function isOwner(userId) { return signedIn() && request.auth.uid == userId; }
    function isAdmin() {
      return signedIn() && exists(/databases/$(database)/documents/app_meta/admins/$(request.auth.uid));
    }

    /* --- tickets gyökérkollekció (csak olvasás) --- */
    match /tickets/{ticketId} {
      // V3: új jegyek nem a gyökérben jönnek létre
      allow create: if false;
      allow read: if signedIn();
      allow update, delete: if false;
    }

    /* --- users/{userId}/tickets alkollekció --- */
    match /users/{userId}/tickets/{ticketId} {
      allow create: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasOnly([
          'id',
          'userId',
          'tips',
          'stake',
          'totalOdd',
          'potentialWin',
          'createdAt',
          'updatedAt',
          'status',
        ]);
      allow read: if isOwner(userId);
      allow update, delete: if false;
    }

    /*  ─── Felhasználói beállítások alkollekció ───  */
    match /users/{userId}/settings/{settingId} {
      allow read, write: if isOwner(userId);
    }

    /* --- public_feed --- */
    match /public_feed/{postId} {
      // Bárki bejelentkezett olvashat.
      allow read: if signedIn();
      // Létrehozni csak saját userként lehet (FeedService ír bejegyzést).
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;

      // Moderation reports subcollection
      match /reports/{reportId} {
        allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
        allow read, update, delete: if false;
      }
    }

    /* --- moderation_reports (legacy path) --- */
    match /moderation_reports/{reportId} {
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if false;
    }

    /* --- users/{uid}/badges subcollection --- */
    match /users/{userId}/badges/{badgeId} {
      allow read: if signedIn();
      allow create: if isOwner(userId);
      allow update, delete: if false;
    }

    /* --- copied_bets --- */
    match /copied_bets/{userId} {
      allow read, write: if isOwner(userId);
      allow delete: if false;
    }

    /* ——— badges (public read) ——— */
    match /badges/{badgeId} {
      allow read: if true;
    }

    /* ——— leaderboards ——— */
    match /leaderboards/{periodId} {
      allow read: if true;
      allow write, delete: if false;
    }

    /* ——— users collection ——— */
    match /users/{userId} {
      allow create: if signedIn() && request.auth.uid == userId;
      // Ranglistához minden hitelesített user olvashatja
      allow read:   if signedIn();
      // When updating nicknameNormalized, enforce that reservation exists and belongs to user
      allow update: if isOwner(userId)
        && (
          request.resource.data.nicknameNormalized == resource.data.nicknameNormalized
          || (
            request.resource.data.nicknameNormalized is string
            && exists(/databases/$(database)/documents/usernames/$(request.resource.data.nicknameNormalized))
            && get(/databases/$(database)/documents/usernames/$(request.resource.data.nicknameNormalized)).data.ownerUid == request.auth.uid
          )
        );
      allow delete: if false;

      /* ——— subcollection: notifications ——— */
      match /notifications/{notifId} {
        allow create: if false;
        allow read:   if isOwner(userId);
        allow update: if isOwner(userId) && request.resource.data.read == true;
        allow delete: if false;
      }

      /* ——— subcollection: friendRequests ——— */
      match /friendRequests/{requestId} {
        allow create: if signedIn() && request.resource.data.fromUid == request.auth.uid;
        allow read:   if signedIn() && (request.auth.uid == resource.data.fromUid || request.auth.uid == resource.data.toUid);
        allow update: if signedIn() && request.resource.data.accepted == true && request.auth.uid == resource.data.toUid;
        allow delete: if false;
      }
    }

    /* ——— relations (followers & friends) ——— */
    match /relations/{uid} {
      match /followers/{followerUid} {
        allow create, delete: if signedIn() && request.auth.uid == followerUid;
        allow read: if true;
        allow update: if false;
      }

      match /following/{targetUid} {
        allow create, delete: if signedIn() && request.auth.uid == uid;
        allow read: if true;
        allow update: if false;
      }

      // Friend requests (kliens által használt útvonal)
      match /friendRequests/{requestId} {
        // Létrehozás: a kérés feladója hozhat létre bejegyzést
        allow create: if signedIn() && request.auth.uid == request.resource.data.fromUid;
        // Olvasás: a cél user vagy a feladó olvashat
        allow read: if isOwner(uid) || (signedIn() && request.auth.uid == request.resource.data.fromUid);
        // Módosítás: a cél user jelölheti accepted=true-re
        allow update: if signedIn() && isOwner(uid);
        // Törlés tiltva
        allow delete: if false;
      }
    }

    /* ——— badgesProgress ——— */
    match /badgesProgress/{uid} {
      allow read: if isOwner(uid);
      allow write, delete: if false;
    }

    /* ——— misc public collections ——— */
    match /appConfig/{docId} {
      allow read: if true;
      allow write, delete: if false;
    }

    /* --- forum --- */
    match /threads/{threadId} {
      allow read: if signedIn();
      allow create: if signedIn()
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.keys().hasOnly([
          'title',
          'type',
          'createdBy',
          'createdAt',
          'pinned',
          'locked',
          'fixtureId',
          'lastActivityAt',
        ]);
      allow update: if isOwner(resource.data.createdBy);
      allow delete: if false;

      match /posts/{postId} {
        allow read: if signedIn();
        allow create: if signedIn()
          && request.resource.data.userId == request.auth.uid
          && !get(/databases/$(database)/documents/threads/$(threadId)).data.locked
          && request.resource.data.keys().hasOnly([
            'id',
            'threadId',
            'userId',
            'type',
            'content',
            'createdAt',
            'editedAt',
          ]);
        allow update, delete: if isOwner(resource.data.userId);
      }

      match /votes/{voteId} {
        allow read: if signedIn();
        allow create, delete: if signedIn() && request.auth.uid == request.resource.data.userId;
        allow update: if false;
      }

      match /reports/{reportId} {
        allow read: if isOwner(resource.data.userId) || isAdmin();
        allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isAdmin() && request.resource.data.keys().hasOnly(['status']);
        allow delete: if false;
      }
    }

    /* --- NEW: user-centric wallet & ledger (SoT) --- */
    match /users/{uid}/wallet/{docId} {
    /* --- usernames reservation (case-insensitive nickname uniqueness) --- */
    match /usernames/{norm} {
      // Anyone can check availability
      allow read: if true;
      // Create only if not existing and caller owns the reservation
      allow create: if signedIn()
        && request.resource.data.ownerUid == request.auth.uid
        && !exists(/databases/$(database)/documents/usernames/$(norm));
      // Update/Delete only by owner
      allow update, delete: if signedIn() && resource.data.ownerUid == request.auth.uid;
    }
      allow read: if isOwner(uid);
      allow write: if false; // Only via CF (Admin SDK)
    }
    match /users/{uid}/ledger/{entryId} {
      allow read: if isOwner(uid);
      allow write: if false; // Only via CF (Admin SDK)
    }
  }
}
