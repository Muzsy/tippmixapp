meta:
  canvas: events_screen_fab_fix.md
  priority: P0

steps:
  - patch_file:
      target: lib/screens/events_screen.dart
      patch: |
        @@
-     if (!widget.showAppBar) {
-       return body;
-     }
-     if (Scaffold.maybeOf(context) != null) {
-       return body;
-     }
-     return Scaffold(
-       appBar: AppBar(title: Text(AppLocalizations.of(context)!.bets_title)),
+     return Scaffold(
+       appBar: widget.showAppBar
+           ? AppBar(title: Text(AppLocalizations.of(context)!.bets_title))
+           : null,
  - create_file:
      target: test/widget/events_screen_fab_test.dart
      content: |
        import 'package:flutter/material.dart';
        import 'package:flutter_riverpod/flutter_riverpod.dart';
        import 'package:flutter_test/flutter_test.dart';
        import 'package:tippmixapp/models/tip_model.dart';
        import 'package:tippmixapp/providers/bet_slip_provider.dart';
        import 'package:tippmixapp/providers/odds_api_provider.dart';
        import 'package:tippmixapp/screens/events_screen.dart';
        import 'package:state_notifier/state_notifier.dart';

        class _StubOddsNotifier extends StateNotifier<OddsApiProviderState> {
          _StubOddsNotifier() : super(OddsApiEmpty());
        }

        void main() {
          testWidgets('FAB appears when tips present', (WidgetTester tester) async {
            final tip = TipModel(
              eventId: '1',
              eventName: 'Test vs Test',
              startTime: DateTime.now(),
              sportKey: 'soccer',
              bookmaker: 'TestBook',
              marketKey: 'h2h',
              outcome: 'Test',
              odds: 2.0,
            );

            await tester.pumpWidget(
              ProviderScope(
                overrides: [
                  betSlipProvider.overrideWith((ref) {
                    final notifier = BetSlipProvider();
                    notifier.addTip(tip);
                    return notifier;
                  }),
                  oddsApiProvider.overrideWith((ref) => _StubOddsNotifier()),
                ],
                child: const MaterialApp(
                  home: EventsScreen(sportKey: 'soccer', showAppBar: true),
                ),
              ),
            );
            await tester.pumpAndSettle();
            expect(find.byKey(const Key('create_ticket_button')), findsOneWidget);
          });
        }
  - run: flutter test
  - run: flutter analyze
