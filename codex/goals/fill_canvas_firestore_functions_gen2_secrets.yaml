version: 1
kind: codex
metadata:
  id: tmx-step1-gen2-secrets
  title: "TMX Step1 – Gen2+Secrets"
  related_canvas: "TMX Step1 – Gen2+Secrets – Functions Refactor (2025-08-22)"
  owners: ["tippmixapp"]
  tags: ["firebase-functions","gen2","secret-manager","scheduler","europe-central2"]

workspace:
  root: "/workspace"
  before:
    - run: |
        cd cloud_functions
        node -v || true
        npm -v || true
        npm ci
  after:
    - run: |
        cd cloud_functions
        npm run build
        npm test --silent || true

changes:
  - type: patch_file
    path: cloud_functions/index.ts
    description: "Gen2 globális opciók + Secret Manager binding a match_finalizer-hez"
    patch: |
      --- cloud_functions/index.ts
      +++ cloud_functions/index.ts
      @@
      -import { onMessagePublished } from 'firebase-functions/v2/pubsub';
      +import { setGlobalOptions } from 'firebase-functions/v2';
      +import { onMessagePublished } from 'firebase-functions/v2/pubsub';
      +import { defineSecret } from 'firebase-functions/params';
       import { match_finalizer as matchFinalizerHandler } from './src/match_finalizer';
       
       export { onUserCreate, coin_trx } from './coin_trx.logic';
       export { log_coin } from './log_coin';
       export { onFriendRequestAccepted } from './friend_request';
       export { daily_bonus } from './src/daily_bonus';
       
      +// Global options for all v2 functions
      +setGlobalOptions({ region: 'europe-central2' });
      +
      +// Secret from Secret Manager (Console → Secret Manager → API_FOOTBALL_KEY)
      +export const API_FOOTBALL_KEY = defineSecret('API_FOOTBALL_KEY');
      +
       // Gen2 Pub/Sub trigger (topic: result-check, region via global options)
      -export const match_finalizer = onMessagePublished('result-check', async (event) => {
      +export const match_finalizer = onMessagePublished({ topic: 'result-check', secrets: [API_FOOTBALL_KEY] }, async (event) => {
         const msg = {
           data: event.data.message?.data,
           attributes: event.data.message?.attributes as { [key: string]: string } | undefined,
         };
         await matchFinalizerHandler(msg as any);
       });

  - type: patch_file
    path: cloud_functions/src/daily_bonus.ts
    description: "gen1 scheduler → v2/scheduler + régió egységesítés"
    patch: |
      --- cloud_functions/src/daily_bonus.ts
      +++ cloud_functions/src/daily_bonus.ts
      @@
      -import * as functions from 'firebase-functions';
      +import { onSchedule } from 'firebase-functions/v2/scheduler';
      +import { setGlobalOptions } from 'firebase-functions/v2';
       import { db } from './lib/firebase';
       import { CoinService } from './services/CoinService';
       
      -export const daily_bonus = functions
      -  .region('europe-central2')
      -  .pubsub.schedule('5 0 * * *')
      -  .timeZone('Europe/Budapest')
      -  .onRun(async () => {
      +// region default for v2
      +setGlobalOptions({ region: 'europe-central2' });
      +
      +export const daily_bonus = onSchedule(
      +  { schedule: '5 0 * * *', timeZone: 'Europe/Budapest' },
      +  async () => {
           const usersSnap = await db.collection('users').get();
           const bonusCoins = 50;
           const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
           const refId = `daily_bonus_${today}`;
      -
           for (const doc of usersSnap.docs) {
             const uid = doc.id;
             await new CoinService().credit(uid, bonusCoins, refId);
           }
      -  });
      +  }
      +);

notes:
  - "Lásd a kapcsolódó vásznat: TMX Step1 – Gen2+Secrets – Functions Refactor (2025-08-22)."
  - "A `API_FOOTBALL_KEY` titoknak a Functions runtime service account számára olvashatónak kell lennie (roles/secretmanager.secretAccessor)."
  - "A `ApiFootballResultProvider` a `process.env.API_FOOTBALL_KEY`-et olvassa, a v2 secret binding ezt automatikusan beállítja a futásidőben."
