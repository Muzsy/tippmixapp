steps:
  - name: V1→V2 Pub/Sub trigger migrálása Gen2-hez
    description: Cseréld le a firebase-functions v1 Pub/Sub API-t v2-re, és adj adaptert a meglévő handlerhez, hogy ne kelljen üzleti logikát módosítani. A régiót a globális beállítás kezeli (friend_request.ts), külön region() hívás nem kell.
    outputs:
      - path: cloud_functions/index.ts
        diff: |
          --- a/cloud_functions/index.ts
          +++ b/cloud_functions/index.ts
          @@ -1,12 +1,15 @@
          - import * as functions from 'firebase-functions';
          - import { match_finalizer as matchFinalizerHandler } from './src/match_finalizer';
          +import { onMessagePublished } from 'firebase-functions/v2/pubsub';
          +import { match_finalizer as matchFinalizerHandler } from './src/match_finalizer';
           
          - export { onUserCreate, coin_trx } from './coin_trx.logic';
          - export { log_coin } from './log_coin';
          - export { onFriendRequestAccepted } from './friend_request';
          +export { onUserCreate, coin_trx } from './coin_trx.logic';
          +export { log_coin } from './log_coin';
          +export { onFriendRequestAccepted } from './friend_request';
           
          - // Pub/Sub trigger: 'result-check' topic, régió: europe-central2
          - export const match_finalizer = functions
          -   .region('europe-central2')
          -   .pubsub.topic('result-check')
          -   .onPublish(matchFinalizerHandler);
          +// Gen2 Pub/Sub trigger (topic: result-check, region via global options)
          +export const match_finalizer = onMessagePublished('result-check', async (event) => {
          +  const msg = {
          +    data: event.data.message?.data,
          +    attributes: event.data.message?.attributes as { [key: string]: string } | undefined,
          +  };
          +  await matchFinalizerHandler(msg as any);
          +});
  - name: Build
    description: Telepítsd a függőségeket és fordítsd le a functions csomagot.
    outputs:
      - sh: |
          cd cloud_functions
          npm ci
          npm run build
  - name: Deploy (match_finalizer only)
    description: Deploy csak a match_finalizer függvényre, europe-central2 régióban.
    outputs:
      - sh: |
          firebase deploy --only functions:match_finalizer --project tippmix-dev --region europe-central2
  - name: Smoke test és ellenőrzés
    description: Küldj teszt üzenetet a Pub/Sub topicra és ellenőrizd, hogy nincs GCLOUD_PROJECT hiba; a handler logolja a beérkező job-ot és lefut a finalizációs ciklus.
    outputs:
      - sh: |
          gcloud pubsub topics publish result-check --project=tippmix-dev --message='{"job":"final-sweep"}'
          # Logs Explorerben keresd: "[match_finalizer] received job: final-sweep"
    inputs:
      - note: A topicnak (result-check) léteznie kell a tippmix-dev projektben. Ha nem létezik, hozd létre: `gcloud pubsub topics create result-check --project=tippmix-dev`.
