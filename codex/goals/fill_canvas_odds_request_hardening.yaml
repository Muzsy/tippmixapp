# Codex Canvas Yaml – /odds hívás „betonbiztos” generálása (aktuális tippmixapp.zip‑hez igazított, PONTOS diffek)

steps:
  - name: Patch – bookmaker szűkítés + státuszlog az /odds hívásban
    inputs:
      - file: tippmixapp-main/lib/services/api_football_service.dart
    outputs:
      - type: patch
        file: tippmixapp-main/lib/services/api_football_service.dart
        content: |
          --- a/tippmixapp-main/lib/services/api_football_service.dart
          +++ b/tippmixapp-main/lib/services/api_football_service.dart
          @@
               // Uri-alapú query összerakás – elkerüli a 'season=2025bet=1' összefolyást
               final qp = <String, String>{
                 'fixture': fixtureId,
          +      'bookmaker': '$defaultBookmakerId',
                 if (season != null) 'season': '$season',
                 if (includeBet1) 'bet': '1',
               };
               final uri = Uri.parse('$_baseUrl/odds').replace(queryParameters: qp);
          @@
               try {
                 res = await attempt();
               } catch (_) {
                 await Future.delayed(const Duration(milliseconds: 200));
                 res = await attempt();
               }
          +    assert(() { // debug: log odds HTTP status
          +      // ignore: avoid_print
          +      print('[odds] RES ${res.statusCode}');
          +      return true;
          +    }());
               // 429 eset – rövid backoff és 1× retry
               if (res.statusCode == 429) {
                 await Future.delayed(const Duration(milliseconds: 200));
                 res = await attempt();
               }
               if (res.statusCode >= 200 && res.statusCode < 300) {
                 final body = jsonDecode(res.body) as Map<String, dynamic>;
                 return body;
               }
               return {};

  - name: Patch – robusztus fixtureId és season‑fallback a kártyában
    inputs:
      - file: tippmixapp-main/lib/widgets/event_bet_card.dart
    outputs:
      - type: patch
        file: tippmixapp-main/lib/widgets/event_bet_card.dart
        content: |
          --- a/tippmixapp-main/lib/widgets/event_bet_card.dart
          +++ b/tippmixapp-main/lib/widgets/event_bet_card.dart
          @@
-                return FutureBuilder<OddsMarket?>(
+                final fid = int.tryParse(event.id) ?? int.tryParse(RegExp(r'\\d+').firstMatch(event.id)?.group(0) ?? '') ?? 0;
+                return FutureBuilder<OddsMarket?>(
                   key: ValueKey('markets-${event.id}'),
                   future: apiService.getH2HForFixture(
-                    int.tryParse(event.id) ?? 0,
-                    season: event.season,
+                    fid,
+                    season: event.season ?? event.commenceTime.year,
                     homeName: event.homeTeam,
                     awayName: event.awayTeam,
                   ),

  - name: Build & Lint
    description: Ellenőrzés a Flutter és a Dart oldalán.
    outputs:
      - Parancs futtatva: flutter analyze
      - Parancs futtatva: flutter test -r expanded

  - name: Megjegyzés a monitorozáshoz
    description: A debug státuszlog (`[odds] RES <status>`) kizárólag assert módban fut. Release buildnél nem zajosítja a logot.
