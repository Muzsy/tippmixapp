meta:
  canvas: wallet_lazy_init_docs.md
  priority: P0

steps:
  # 1Ô∏è‚É£ CoinService ‚Äì wallet lazy‚Äëcreate finomhangol√°sa
  - patch_file:
      target: lib/services/coin_service.dart
      patch: |
        @@
-              if (walletSnap.exists && walletSnap.data()!.containsKey('coins')) {
-                current = walletSnap.data()!['coins'] as int;
-              } else {
-                final userSnap = await txn.get(userRef);
-                current = (userSnap.data()?['coins'] as int?) ?? 0;
-
-                // LAZY‚ÄëCREATE wallet doc so next ops hit it directly
-                txn.set(walletRef, {
-                  'coins': current,
-                  'createdAt': FieldValue.serverTimestamp(),
-                }, SetOptions(merge: true));
-              }
+              if (walletSnap.exists && walletSnap.data()!.containsKey('coins')) {
+                current = walletSnap.data()!['coins'] as int;
+              } else {
+                // ‚û°Ô∏è fallback: read balance from users doc
+                final userSnap = await txn.get(userRef);
+                current = (userSnap.data()?['coins'] as int?) ?? 0;
+
+                // ‚û°Ô∏è LAZY‚ÄëCREATE wallet doc so subsequent requests use it
+                txn.set(walletRef, {
+                  'coins': current,
+                  'createdAt': FieldValue.serverTimestamp(),
+                });
+              }
@@
-              // write back to wallet (now guaranteed to exist)
-              txn.set(walletRef, {'coins': current - stake}, SetOptions(merge: true));
+              // write back to wallet (now guaranteed to exist)
+              txn.update(walletRef, {'coins': current - stake});

  # 2Ô∏è‚É£ Data Model EN ‚Äì deprecate coins + add WalletModel
  - patch_file:
      target: docs/backend/data_model_en.md
      patch: |
        @@
-Stores registered user data and TippCoin balance.
+Stores registered user data. **TippCoin balance moved to the WalletModel (see below).**
+
+> ‚ö†Ô∏è **Deprecated field**: `coins` ‚Äì kept temporarily for backward compatibility. It will be removed after the Cloud¬†Function‚Äëbased wallet initialisation rollout.
@@
-```dart
-UserModel {
-  String uid;
-  String email;
-  String? displayName;
+```dart
+UserModel {
+  String uid;
+  String email;
+  String? displayName;
+  // int coins; // DEPRECATED ‚Äì see WalletModel
@@
+# üí∞ WalletModel (NEW)
+
+Stores TippCoin balance per user.
+
+```dart
+WalletModel {
+  String userId;   // same as auth.uid
+  int coins;       // Current TippCoin balance
+  Timestamp createdAt;
+}
+```
+
+- Location: `wallets/{userId}`
+- This document is **lazy‚Äëcreated** by the mobile client on the first bet.
+- Later it will be initialised automatically via an **Auth onCreate Cloud Function**.
+
  ## üîú Planned models

  - `Tip...`

  # (keep rest unchanged)

  # 3Ô∏è‚É£ Data Model HU ‚Äì ugyanaz magyarul
  - patch_file:
      target: docs/backend/data_model_hu.md
      patch: |
        @@
-A felhaszn√°l√≥ adatait √©s TippCoin egyenleg√©t t√°rolja.
+A felhaszn√°l√≥ adatait t√°rolja. **A TippCoin‚Äëegyenleg √°tker√ºlt a WalletModel‚Äëbe.**
+
+> ‚ö†Ô∏è **Elavult mez≈ë**: `tippCoin` ‚Äì ideiglenesen marad a kompatibilit√°s kedv√©√©rt, de hamarosan t√∂rl√©sre ker√ºl, miut√°n a Cloud Function inicializ√°lja a wallet doksit.
@@
-```dart
-UserModel {
-  String uid;
-  String email;
-  String? displayName;
+```dart
+UserModel {
+  String uid;
+  String email;
+  String? displayName;
+  // int tippCoin; // ELAVULT ‚Äì l√°sd WalletModel
@@
+# üí∞ WalletModel (√öJ)
+
+TippCoin‚Äëegyenleg t√°rol√°sa felhaszn√°l√≥nk√©nt.
+
+```dart
+WalletModel {
+  String userId;   // ugyanaz, mint az auth.uid
+  int coins;       // aktu√°lis TippCoin egyenleg
+  Timestamp createdAt;
+}
+```
+
+- El√©r√©si √∫t: `wallets/{userId}`
+- A dokumentum **lazy‚Äëcreate** m√≥don j√∂n l√©tre az els≈ë fogad√°skor.  
+  K√©s≈ëbb egy **Auth onCreate** Cloud Function fogja automatikusan l√©trehozni.
+
  ## üîú Tervezett modellek

  - `TippCoinLogModel` ... (marad v√°ltozatlan)

  # 4Ô∏è‚É£ CI ‚Äì elemz√©s + tesztek + markdown-lint (ha van)
  - run: flutter analyze
  - run: flutter test
